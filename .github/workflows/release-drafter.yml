name: Release Drafter

on:
  push:
    branches:
      - master
      - feat/release-draft
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  update_release_draft:
    name: Update release draft
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Generate Release Drafter config with supporters
        env:
          BMC_API_TOKEN: ${{ secrets.BMC_API_TOKEN }}
          BMC_SLUG: ${{ secrets.BMC_SLUG }}
        run: |
          set -eu

          SUPPORTERS_SECTION="$(python .github/scripts/generate_supporters_section.py)"

          # Escape &, /, \ and # for sed replacement
          SUPPORTERS_SECTION_ESCAPED=$(printf '%s\n' "$SUPPORTERS_SECTION" \
            | sed -e 's/[&/\]/\\&/g' \
                  -e 's/#/\\#/g')

          sed "s#<!-- SUPPORTERS_SECTION -->#${SUPPORTERS_SECTION_ESCAPED}#" \
            .github/release-drafter.base.yml \
            > .github/release-drafter.generated.yml
      - name: Create Release
        uses: release-drafter/release-drafter@v6
        with:
          disable-releaser: github.ref != 'refs/heads/main'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
