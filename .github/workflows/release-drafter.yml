name: Release Drafter

on:
  push:
    branches:
      - master
      - beta

jobs:
  update_release_draft:
    name: Update release draft
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Generate Release Drafter config with supporters
        id: supporters
        env:
          BMC_API_TOKEN: ${{ secrets.BMC_API_TOKEN }}
          BMC_SLUG: ${{ secrets.BMC_SLUG }}
        run: |
          set -eu

          set -eu
          section="$(python .github/scripts/generate_supporters_section.py)"

          # Store multiline output safely
          {
            echo "value<<EOF"
            echo "$section"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
      - name: Create Release
        uses: release-drafter/release-drafter@v6
        with:
          footer: ${{ steps.supporters.outputs.value }}
          config-name: release-drafter.yml

          # Keep drafts separated by branch
          commitish: ${{ github.ref_name }}  # codespell:ignore

          # Mark beta as prerelease and auto-increment beta.N
          prerelease: ${{ github.ref_name == 'beta' }}
          prerelease-identifier: ${{ github.ref_name == 'beta' && 'beta' || '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
