name: Release Drafter

on:
  push:
    branches:
      - master
      - feat/release-draft
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  update_release_draft:
    name: Update release draft
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Generate Release Drafter config with supporters
        env:
          BMC_API_TOKEN: ${{ secrets.BMC_API_TOKEN }}
          BMC_SLUG: ${{ secrets.BMC_SLUG }}
        run: |
          set -eu

          python << 'PY'
          from pathlib import Path
          from subprocess import check_output
          
          section = check_output(
              ["python", ".github/scripts/generate_supporters_section.py"],
              text=True,
          )
          
          base_path = Path(".github/release-drafter.base.yml")
          out_path = Path(".github/release-drafter.generated.yml")
          
          template = base_path.read_text()
          out_path.write_text(template.replace("<!-- SUPPORTERS_SECTION -->", section))
          PY
      - name: Create Release
        uses: release-drafter/release-drafter@v6
        with:
          disable-releaser: github.ref != 'refs/heads/main'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
