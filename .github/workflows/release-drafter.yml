name: Release Drafter

on:
  push:
    branches:
      - master
      - feat/release-draft
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  update_release_draft:
    name: Update release draft
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Generate Release Drafter config with supporters
        id: supporters
        env:
          BMC_API_TOKEN: ${{ secrets.BMC_API_TOKEN }}
          BMC_SLUG: ${{ secrets.BMC_SLUG }}
        run: |
          set -eu

          section="$(python .github/scripts/generate_supporters_section.py)"

          # Escape for GitHub output (%, CR, LF)
          section="${section//'%'/'%25'}"
          section="${section//$'\n'/'%0A'}"
          section="${section//$'\r'/'%0D'}"

          echo "value=$section" >> "$GITHUB_OUTPUT"
      - name: Create Release
        uses: release-drafter/release-drafter@v6
        with:
          footer: ${{ steps.supporters.outputs.value }}
          config-name: release-drafter.yml
#          disable-releaser: github.ref != 'refs/heads/main'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
